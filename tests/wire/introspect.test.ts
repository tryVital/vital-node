// This file was auto-generated by Fern from our API Definition.

import * as Vital from "../../src/api/index";
import { VitalClient } from "../../src/Client";
import { mockServerPool } from "../mock-server/MockServerPool";

describe("IntrospectClient", () => {
    test("get_user_resources (1)", async () => {
        const server = mockServerPool.createServer();
        const client = new VitalClient({ maxRetries: 0, apiKey: "test", environment: server.baseUrl });

        const rawResponseBody = {
            data: [
                {
                    user_id: "",
                    provider: {
                        fitbit: {
                            activity: {
                                last_attempt: { timestamp: "2023-10-24T13:13:27Z", status: "success" },
                                oldest_data: "2023-06-21T00:00:00Z",
                                newest_data: "2023-10-24T00:00:00Z",
                                sent_count: 231,
                            },
                        },
                    },
                },
            ],
            next: "next",
            next_cursor: "next_cursor",
        };
        server
            .mockEndpoint()
            .get("/v2/introspect/resources")
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();

        const response = await client.introspect.getUserResources({
            userId: "user_id",
            provider: "oura",
            userLimit: 1,
            cursor: "cursor",
            nextCursor: "next_cursor",
        });
        expect(response).toEqual({
            data: [
                {
                    userId: "",
                    provider: {
                        fitbit: {
                            activity: {
                                lastAttempt: {
                                    timestamp: new Date("2023-10-24T13:13:27.000Z"),
                                    status: "success",
                                },
                                oldestData: new Date("2023-06-21T00:00:00.000Z"),
                                newestData: new Date("2023-10-24T00:00:00.000Z"),
                                sentCount: 231,
                            },
                        },
                    },
                },
            ],
            next: "next",
            nextCursor: "next_cursor",
        });
    });

    test("get_user_resources (2)", async () => {
        const server = mockServerPool.createServer();
        const client = new VitalClient({ maxRetries: 0, apiKey: "test", environment: server.baseUrl });

        const rawResponseBody = {};
        server
            .mockEndpoint()
            .get("/v2/introspect/resources")
            .respondWith()
            .statusCode(422)
            .jsonBody(rawResponseBody)
            .build();

        await expect(async () => {
            return await client.introspect.getUserResources();
        }).rejects.toThrow(Vital.UnprocessableEntityError);
    });

    test("get_user_historical_pulls (1)", async () => {
        const server = mockServerPool.createServer();
        const client = new VitalClient({ maxRetries: 0, apiKey: "test", environment: server.baseUrl });

        const rawResponseBody = {
            data: [
                {
                    user_id: "",
                    provider: {
                        fitbit: {
                            pulled: {
                                activity: {
                                    status: "success",
                                    range_start: "2023-07-24T00:00:00Z",
                                    range_end: "2023-10-24T00:00:00Z",
                                    timeline: {
                                        scheduled_at: "2023-10-24T13:52:51Z",
                                        started_at: "2023-10-24T13:52:54Z",
                                        ended_at: "2023-10-24T13:53:59Z",
                                    },
                                    days_with_data: 70,
                                    release: "0.0.0-dev.cd0e262",
                                    trace_id: "51cc7d2d72e98ed4eb63e2b0864b39e3",
                                },
                                sleep: {
                                    status: "retrying",
                                    range_start: "2023-07-24T00:00:00Z",
                                    range_end: "2023-10-24T00:00:00Z",
                                    timeline: {
                                        scheduled_at: "2023-10-24T13:52:51Z",
                                        started_at: "2023-10-24T13:53:01Z",
                                        ended_at: "2023-10-24T13:53:04Z",
                                    },
                                    days_with_data: 70,
                                    release: "0.0.0-dev.cd0e262",
                                    trace_id: "51cc7d2d72e98ed4eb63e2b0864b39e3",
                                    error_details: "provider_rate_limit_exceeded",
                                },
                            },
                            not_pulled: ["blood_oxygen"],
                        },
                    },
                },
            ],
            next: "next",
            next_cursor: "None",
        };
        server
            .mockEndpoint()
            .get("/v2/introspect/historical_pull")
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();

        const response = await client.introspect.getUserHistoricalPulls({
            userId: "user_id",
            provider: "oura",
            userLimit: 1,
            cursor: "cursor",
            nextCursor: "next_cursor",
        });
        expect(response).toEqual({
            data: [
                {
                    userId: "",
                    provider: {
                        fitbit: {
                            pulled: {
                                activity: {
                                    status: "success",
                                    rangeStart: new Date("2023-07-24T00:00:00.000Z"),
                                    rangeEnd: new Date("2023-10-24T00:00:00.000Z"),
                                    timeline: {
                                        scheduledAt: new Date("2023-10-24T13:52:51.000Z"),
                                        startedAt: new Date("2023-10-24T13:52:54.000Z"),
                                        endedAt: new Date("2023-10-24T13:53:59.000Z"),
                                    },
                                    daysWithData: 70,
                                    release: "0.0.0-dev.cd0e262",
                                    traceId: "51cc7d2d72e98ed4eb63e2b0864b39e3",
                                },
                                sleep: {
                                    status: "retrying",
                                    rangeStart: new Date("2023-07-24T00:00:00.000Z"),
                                    rangeEnd: new Date("2023-10-24T00:00:00.000Z"),
                                    timeline: {
                                        scheduledAt: new Date("2023-10-24T13:52:51.000Z"),
                                        startedAt: new Date("2023-10-24T13:53:01.000Z"),
                                        endedAt: new Date("2023-10-24T13:53:04.000Z"),
                                    },
                                    daysWithData: 70,
                                    release: "0.0.0-dev.cd0e262",
                                    traceId: "51cc7d2d72e98ed4eb63e2b0864b39e3",
                                    errorDetails: "provider_rate_limit_exceeded",
                                },
                            },
                            notPulled: ["blood_oxygen"],
                        },
                    },
                },
            ],
            next: "next",
            nextCursor: "None",
        });
    });

    test("get_user_historical_pulls (2)", async () => {
        const server = mockServerPool.createServer();
        const client = new VitalClient({ maxRetries: 0, apiKey: "test", environment: server.baseUrl });

        const rawResponseBody = {};
        server
            .mockEndpoint()
            .get("/v2/introspect/historical_pull")
            .respondWith()
            .statusCode(422)
            .jsonBody(rawResponseBody)
            .build();

        await expect(async () => {
            return await client.introspect.getUserHistoricalPulls();
        }).rejects.toThrow(Vital.UnprocessableEntityError);
    });
});
