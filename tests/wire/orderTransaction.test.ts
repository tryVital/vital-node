// This file was auto-generated by Fern from our API Definition.

import * as Vital from "../../src/api/index";
import { VitalClient } from "../../src/Client";
import { mockServerPool } from "../mock-server/MockServerPool";

describe("OrderTransactionClient", () => {
    test("get_transaction (1)", async () => {
        const server = mockServerPool.createServer();
        const client = new VitalClient({ maxRetries: 0, apiKey: "test", environment: server.baseUrl });

        const rawResponseBody = {
            id: "id",
            team_id: "team_id",
            status: "status",
            orders: [
                {
                    id: "id",
                    origin: "initial",
                    parent_id: "parent_id",
                    last_status: "ordered",
                    last_status_created_at: "2024-01-15T09:30:00Z",
                    updated_at: "2024-01-15T09:30:00Z",
                    created_at: "2024-01-15T09:30:00Z",
                },
            ],
        };
        server
            .mockEndpoint()
            .get("/v3/order_transaction/transaction_id")
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();

        const response = await client.orderTransaction.getTransaction("transaction_id");
        expect(response).toEqual({
            id: "id",
            teamId: "team_id",
            status: "status",
            orders: [
                {
                    id: "id",
                    origin: "initial",
                    parentId: "parent_id",
                    lastStatus: "ordered",
                    lastStatusCreatedAt: new Date("2024-01-15T09:30:00.000Z"),
                    updatedAt: new Date("2024-01-15T09:30:00.000Z"),
                    createdAt: new Date("2024-01-15T09:30:00.000Z"),
                },
            ],
        });
    });

    test("get_transaction (2)", async () => {
        const server = mockServerPool.createServer();
        const client = new VitalClient({ maxRetries: 0, apiKey: "test", environment: server.baseUrl });

        const rawResponseBody = {};
        server
            .mockEndpoint()
            .get("/v3/order_transaction/transaction_id")
            .respondWith()
            .statusCode(422)
            .jsonBody(rawResponseBody)
            .build();

        await expect(async () => {
            return await client.orderTransaction.getTransaction("transaction_id");
        }).rejects.toThrow(Vital.UnprocessableEntityError);
    });

    test("get_transaction_result (1)", async () => {
        const server = mockServerPool.createServer();
        const client = new VitalClient({ maxRetries: 0, apiKey: "test", environment: server.baseUrl });

        const rawResponseBody = {
            metadata: {
                age: "age",
                dob: "18/08/1993",
                "clia_#": "clia_#",
                patient: "Bob Smith",
                provider: "Dr. Jack Smith",
                laboratory: "Quest Diagnostics",
                date_reported: "2020-01-01",
                date_collected: "2022-02-02",
                specimen_number: "123131",
                date_received: "2022-01-01",
                status: "final",
                interpretation: "normal",
                patient_id: "patient_id",
                account_id: "account_id",
            },
            results: [
                {
                    name: "Monocytes(Absolute)",
                    slug: "monocytes-absolute",
                    result: "0.4",
                    type: "numeric",
                    unit: "x10E3/uL",
                    timestamp: "2023-11-01T08:28:00Z",
                    notes: "Final",
                    reference_range: "reference_range",
                    min_range_value: 0.1,
                    max_range_value: 0.9,
                    is_above_max_range: false,
                    is_below_min_range: false,
                    interpretation: "normal",
                    loinc: "742-7",
                    loinc_slug: "monocytes-auto-bld-vol",
                    provider_id: "provider_id",
                    source_markers: [{ marker_id: 1, name: "name", slug: "slug" }],
                    performing_laboratory: "performing_laboratory",
                    source_sample_id: "source_sample_id",
                },
            ],
            missing_results: [
                {
                    name: "name",
                    slug: "slug",
                    inferred_failure_type: "quantity_not_sufficient_failure",
                    note: "note",
                    loinc: "loinc",
                    loinc_slug: "loinc_slug",
                    provider_id: "provider_id",
                    source_markers: [{ marker_id: 1, name: "name", slug: "slug" }],
                },
            ],
            sample_information: {
                key: {
                    sample_id: "sample_id",
                    control_number: "control_number",
                    date_collected: { timestamp: "2024-01-15T09:30:00Z", timezone_offset: 1 },
                    date_received: { timestamp: "2024-01-15T09:30:00Z", timezone_offset: 1 },
                    date_reported: { timestamp: "2024-01-15T09:30:00Z", timezone_offset: 1 },
                },
            },
        };
        server
            .mockEndpoint()
            .get("/v3/order_transaction/transaction_id/result")
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();

        const response = await client.orderTransaction.getTransactionResult("transaction_id");
        expect(response).toEqual({
            metadata: {
                age: "age",
                dob: "18/08/1993",
                clia: "clia_#",
                patient: "Bob Smith",
                provider: "Dr. Jack Smith",
                laboratory: "Quest Diagnostics",
                dateReported: "2020-01-01",
                dateCollected: "2022-02-02",
                specimenNumber: "123131",
                dateReceived: "2022-01-01",
                status: "final",
                interpretation: "normal",
                patientId: "patient_id",
                accountId: "account_id",
            },
            results: [
                {
                    name: "Monocytes(Absolute)",
                    slug: "monocytes-absolute",
                    result: "0.4",
                    type: "numeric",
                    unit: "x10E3/uL",
                    timestamp: new Date("2023-11-01T08:28:00.000Z"),
                    notes: "Final",
                    referenceRange: "reference_range",
                    minRangeValue: 0.1,
                    maxRangeValue: 0.9,
                    isAboveMaxRange: false,
                    isBelowMinRange: false,
                    interpretation: "normal",
                    loinc: "742-7",
                    loincSlug: "monocytes-auto-bld-vol",
                    providerId: "provider_id",
                    sourceMarkers: [
                        {
                            markerId: 1,
                            name: "name",
                            slug: "slug",
                        },
                    ],
                    performingLaboratory: "performing_laboratory",
                    sourceSampleId: "source_sample_id",
                },
            ],
            missingResults: [
                {
                    name: "name",
                    slug: "slug",
                    inferredFailureType: "quantity_not_sufficient_failure",
                    note: "note",
                    loinc: "loinc",
                    loincSlug: "loinc_slug",
                    providerId: "provider_id",
                    sourceMarkers: [
                        {
                            markerId: 1,
                            name: "name",
                            slug: "slug",
                        },
                    ],
                },
            ],
            sampleInformation: {
                key: {
                    sampleId: "sample_id",
                    controlNumber: "control_number",
                    dateCollected: {
                        timestamp: new Date("2024-01-15T09:30:00.000Z"),
                        timezoneOffset: 1,
                    },
                    dateReceived: {
                        timestamp: new Date("2024-01-15T09:30:00.000Z"),
                        timezoneOffset: 1,
                    },
                    dateReported: {
                        timestamp: new Date("2024-01-15T09:30:00.000Z"),
                        timezoneOffset: 1,
                    },
                },
            },
        });
    });

    test("get_transaction_result (2)", async () => {
        const server = mockServerPool.createServer();
        const client = new VitalClient({ maxRetries: 0, apiKey: "test", environment: server.baseUrl });

        const rawResponseBody = {};
        server
            .mockEndpoint()
            .get("/v3/order_transaction/transaction_id/result")
            .respondWith()
            .statusCode(422)
            .jsonBody(rawResponseBody)
            .build();

        await expect(async () => {
            return await client.orderTransaction.getTransactionResult("transaction_id");
        }).rejects.toThrow(Vital.UnprocessableEntityError);
    });
});
